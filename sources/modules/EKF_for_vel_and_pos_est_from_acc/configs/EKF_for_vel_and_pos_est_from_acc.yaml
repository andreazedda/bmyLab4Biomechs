# EKF for Velocity and Position Estimation from Linear Acceleration
# Complete configuration following the comprehensive requirements

ekf:
  sample_rate_hz: 100.0
  gravity_mps2: 9.80665           # if data is linear acceleration (gravity removed), set use_gravity_compensation=false
  use_gravity_compensation: false  # true if raw accel contains gravity
  
  # Initial state and covariance - FAST CONVERGENCE FOR BIOMECHANICS
  initial_state: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]  # 9D: [pos_x, pos_y, pos_z, vel_x, vel_y, vel_z, bias_x, bias_y, bias_z]
  initial_covariance: 
    position: 100.0              # MUCH HIGHER - we don't know initial position well
    velocity: 10.0               # MUCH HIGHER - allow rapid velocity adaptation  
    bias: 1.0                    # HIGHER - faster bias learning
  
  clamp_accel:
    enabled: true
    min: -30.0
    max: 30.0

  # State & noise (discrete-time) - AGGRESSIVE BIOMECHANICAL TUNING
  process_noise:
    position: 0.00001            # m^2 - increased for more position tracking (1e-5) 
    velocity: 0.002              # (m/s)^2 - MUCH higher for noisy accel data (2e-3)
    bias: 0.00005                # (m/s^2)^2 - increased bias adaptation (5e-5)
    z_axis_reduction_factor: 0.1 # riduci ancora la dinamica verticale
  
  measurement_noise: 0.01        # increased R to reduce over-trust in noisy measurements (1e-2)
  
  # Velocity constraint for cyclic motion (biomechanical improvement)
  velocity_constraint:
    enabled: true
    apply_every: 200             # Apply constraint every 2 seconds (MORE FREQUENT)
    window_size: 300             # Use 3-second window for velocity statistics  
    max_correction: 2.0          # HIGHER maximum velocity correction [m/s]
    correction_factor: 0.5       # AGGRESSIVE 50% correction factor
  
  # Position constraint for cyclic motion (biomechanical improvement)
  position_constraint:
    enabled: true
    apply_every: 500             # Apply constraint every 5 seconds
    window_size: 1000            # Use 10-second window for position statistics
    max_correction: 10.0         # Maximum position correction [m]
    correction_factor: 0.3       # 30% position correction factor
  
  # Real-time velocity baseline removal (biomechanical improvement)
  velocity_baseline_removal:
    enabled: false              # Disabled for testing
    window_size: 500             # Rolling window for baseline estimation (5 seconds)
    removal_factor: 0.2          # 20% baseline removal (aggressive for biomechanics)
  
  # Additional measurement noise for ZUPT
  zupt_measurement_noise:
    vx: 0.0005  # 5e-4
    vy: 0.0005  # 5e-4
    vz: 0.0005  # 5e-4

  # ZUPT detector configuration - MORE PERMISSIVE FOR BIOMECHANICAL DATA
  zupt:
    enabled: true
    window_size: 30              # Shorter window (0.3s) for faster response
    window_samples: 30
    accel_threshold: 0.15        # HIGHER threshold - more permissive  
    acc_mean_thr: 0.12           # HIGHER - allow more movement
    variance_threshold: 0.08     # HIGHER - more permissive
    acc_std_thr: 0.1             # HIGHER - allow more variation
    velocity_threshold: 0.15     # HIGHER - allow higher velocities
    velocity_std_threshold: 0.2  # HIGHER - more permissive
    min_stationary_frames: 5     # LOWER - apply ZUPT quicker
    cooldown_samples: 10         # LOWER - allow more frequent ZUPT
    adaptive_thresholds: true
    auto_relax_after: 60         # FASTER relaxation (~0.6s)
    relaxation_rate: 0.6         # FASTER rate
    max_relax_factor: 6.0        # HIGHER max factor
    debug: true

  # Stability & numerics
  numerics:
    use_joseph: true
    force_symmetry: true
    min_eig_floor: 1e-12
    trace_warn: 1000.0
    trace_abort: 1e6
    reset_on_nan: true

  # Diagnostics configuration
  diagnostics:
    log_every_n: 50
    save_dashboard: true
    compute_acf: true
    whiteness_test: true   # Ljung-Box or equivalent on innovations during ZUPT
    compute_nees: false    # if you have ground-truth x, else false
    compute_nis: true

# Resampling configuration
resampling:
  enabled: false
  target_hz: 100.0
  method: "linear"  # linear, cubic, spline

# Preprocessing configuration (applied to acceleration before EKF)
preprocessing:
  enabled: true
  
  # Auto-bias estimation from initial samples (biomechanical improvement)
  auto_bias:
    enabled: true
    initial_samples: 200         # Use first 2 seconds to estimate bias
  
  # Warm-up phase for filter stabilization  
  warmup:
    enabled: true
    skip_samples: 300            # Skip first 3 seconds for filter convergence
    fast_convergence: true       # Use higher process noise during warmup
  
  # Low-pass filter to remove high-frequency noise
  lowpass_filter:
    enabled: true
    cutoff_hz: 12.0              # Slightly lower for biomechanical data
    order: 4                     # 4th order Butterworth
  
  # Median filter to remove spikes/outliers
  median_filter:
    enabled: true
    kernel_size: 7               # Larger kernel for more aggressive spike removal
  
  # High-pass filter to remove DC drift (optional)
  highpass_filter:
    enabled: false
    cutoff_hz: 0.1               # Remove very slow drift
    order: 2

# Post-processing configuration
postprocess:
  enable: true
  
  # Detrend velocity to remove linear drift
  detrend_velocity:
    enabled: true
  
  # Detrend position to remove linear drift  
  detrend_position:
    enabled: true
  
  # High-pass filter on position to remove DC offset
  position_highpass:
    enabled: true
    cutoff_hz: 0.05      # Very low frequency to preserve movement
    order: 2
  
  # Savitzky-Golay smoothing for periodic motion
  savgol_smooth:
    enabled: true
    window_length: 51    # Must be odd, larger = smoother
    polyorder: 3         # Polynomial order
  
  # Legacy drift correction
  drift_correction:
    enabled: false        # Disabled since we use detrending above
    poly_order: 2
    scope: "global"
    
  # Legacy smoothing
  smoothing:
    enabled: false        # Disabled since we use savgol above
    method: "savgol"
    window: 7
    polyorder: 2
    
  outlier_removal:
    enabled: true
    method: "iqr"
    iqr_factor: 1.5

# Input/Output configuration
io:
  output_dir: "data/outputs"
  save_plots: true
  save_csv: true
  save_reports: true
  default_input_key: linear
  input_files:
    linear:
      filename: 'data/inputs/FILE_SENSOR_ACCELERATION_LINEAR2023-3-21-11-6-14.txt'
      delimiter: ','
      accel_columns: [1, 2, 3]
    uncalibrated:
      filename: 'data/inputs/FILE_SENSOR_ACCELERATION_UNCALIBRATED2023-3-21-11-6-14.txt'
      delimiter: ','
      accel_columns: [1, 2, 3]
  
  output:
    csv_dir: "csv"
    json_dir: "json"
    yaml_dir: "yaml"
    png_dir: "png"
    logs_dir: "logs"
    position_csv: "estimated_position_{axis}.csv"
    velocity_csv: "estimated_velocity_{axis}.csv"
    diagnostics_yaml: "diagnostics_{axis}.yaml"
    optimization_json: "optimization_report.json"
    tuning_json: "tuning_report_{axis}.json"

# Plotting configuration
plots:
  style: "default"
  show_zupt_markers: true
  figsize: [14, 9]

# Output validation
output_validation:
  enabled: true
  velocity_bounds:
    min_value: -5.0      # m/s - Velocità minima accettabile
    max_value: 5.0       # m/s - Velocità massima accettabile
    max_std: 1.0         # m/s - Deviazione standard massima accettabile
    
  position_bounds:
    min_value: -10.0     # m - Posizione minima accettabile
    max_value: 10.0      # m - Posizione massima accettabile
    max_std: 2.0         # m - Deviazione standard massima accettabile
    
  acceleration_bounds:
    min_value: -20.0     # m/s² - Accelerazione minima accettabile
    max_value: 20.0      # m/s² - Accelerazione massima accettabile
    max_std: 5.0         # m/s² - Deviazione standard massima accettabile
    
  # Controlli di consistenza fisica
  physics_validation:
    max_velocity_change: 2.0    # m/s - Cambio massimo di velocità per campione
    max_acceleration_change: 10.0  # m/s² - Cambio massimo di accelerazione per campione
    drift_threshold: 0.1        # m/s - Soglia per rilevare deriva eccessiva
    
  # Azioni in caso di validazione fallita
  validation_actions:
    on_bounds_violation: 'warn'     # 'warn', 'error', 'ignore'
    on_physics_violation: 'warn'    # 'warn', 'error', 'ignore'
    on_drift_detection: 'correct'   # 'warn', 'error', 'correct', 'ignore'
    
# Legacy configuration (for backward compatibility)
acceleration_type: 'linear'
analysis_axis: 'all'

# Execution control
execution_control:
  mode: 'auto'
  step_by_step:
    enabled: false
    pause_after_preprocessing: false
    pause_after_ekf: false
    pause_after_postprocessing: false
    pause_before_visualization: false
    pause_before_completion: false
  user_confirmations:
    confirm_before_optimization: false
    confirm_parameter_changes: false
    confirm_file_overwrites: true
  backup_existing_files: true
  create_timestamp_folders: true

# Debug and validation
debug:
  enable_debug_output: true
  verbose: true
  log_every_n: 25
  print_state_snapshots: false
  log_innovations: true

# Algorithm choices
algorithm_choices:
  ekf_variant: 'standard'
  drift_correction_method: 'polynomial'
  optimization_algorithm: 'adaptive'
  smoothing_method: 'savgol'
  outlier_detection: 'iqr'

# Parametri per Zero-Velocity Update (ZUPT) - OTTIMIZZATI per migliore detection
zupt:
  enabled: true        # Abilita/disabilita la tecnica ZUPT
  window_size: 30      # Ridotta per detection più reattiva
  threshold: 0.05      # Soglia più bassa per catturare meglio i periodi stazionari
  min_duration: 10     # Durata minima aumentata per evitare falsi positivi

# Parametri per la correzione della deriva
drift_correction:
  enabled: true       # Abilita/disabilita la correzione della deriva
  polynomial_order: 2  # Ordine del polinomio per rimuovere la deriva non lineare

# Parametri per il post-processing e smoothing
post_processing:
  velocity_smoothing:
    enabled: true      # Abilita smoothing delle velocità
    window_size: 7     # Dimensione finestra per media mobile
    method: "savgol"   # Metodo: "moving_average", "savgol", "median"
    savgol_polyorder: 3  # Ordine polinomiale per Savitzky-Golay
  
  outlier_removal:
    enabled: true      # Abilita rimozione outlier
    threshold: 2.5     # Soglia in deviazioni standard per outlier
    method: "iqr"      # Metodo: "std", "iqr", "zscore"

# Parametri per l'ottimizzazione automatica
auto_tuning:
  enabled: true        # Abilita/disabilita l'ottimizzazione automatica dei parametri
  max_iterations: 10   # Numero massimo di iterazioni di ottimizzazione  
  convergence_threshold: 0.02  # Soglia di convergenza (2% miglioramento minimo)
  save_best_config: true       # Salva automaticamente la migliore configurazione trovata
  verbose: true        # Output dettagliato dell'ottimizzazione

# Parametri per il monitoraggio delle prestazioni EKF
performance_monitoring:
  enabled: true          # Abilita/disabilita il monitoraggio delle prestazioni
  
  # Soglie per il controllo qualità
  max_trace: 1000.0                      # Soglia massima per la traccia della matrice P
  min_log_likelihood: -1000.0            # Soglia minima per la log-likelihood
  
  # Soglie per i test di consistenza statistica (basate su distribuzione Chi-quadrato)
  nees_upper_bound: 15.5                 # Soglia superiore NEES (95% per 4 DOF)
  nees_lower_bound: 0.71                 # Soglia inferiore NEES (5% per 4 DOF) 
  nis_upper_bound: 6.63                  # Soglia superiore NIS (95% per 1 DOF)
  
  # Parametri per l'analisi della bianchezza delle innovazioni
  innovation_correlation_threshold: 0.1   # Soglia per la correlazione delle innovazioni
  max_lag_autocorr: 20                   # Numero massimo di lag per l'autocorrelazione
  
  # Parametri per la convergenza
  convergence_window: 50                 # Finestra per calcolare la convergenza
  convergence_variance_threshold: 0.01   # Soglia di varianza relativa per la convergenza
  
  # Controlli periodici durante l'esecuzione
  convergence_check_interval: 100       # Controlla convergenza ogni N iterazioni
  
  # Opzioni di reporting
  generate_performance_plots: true      # Genera grafici delle prestazioni
  save_performance_report: true        # Salva report delle prestazioni in file
  performance_report_format: 'yaml'    # Formato del report ('yaml', 'json', 'txt')
  
  # ============================================
  # ANALISI AVANZATE DI VALIDAZIONE E TUNING
  # ============================================
  enable_advanced_analysis: true        # Abilita analisi avanzate (innovazioni, NIS, residui, ecc.)
  
  # Analisi delle innovazioni
  innovation_analysis:
    enabled: true
    test_normality: true                 # Test Shapiro-Wilk e Jarque-Bera per normalità
    test_autocorrelation: true           # Test autocorrelazione delle innovazioni
    max_autocorr_threshold: 0.15         # Soglia massima autocorrelazione accettabile
    normality_p_threshold: 0.01         # Soglia p-value per test normalità
  
  # Analisi NIS (Normalized Innovation Squared)
  nis_analysis:
    enabled: true
    confidence_level: 0.95               # Livello di confidenza per bounds Chi-squared
    min_percentage_in_bounds: 90         # Percentuale minima campioni entro bounds
    rolling_window_size: 50              # Finestra per analisi rolling
  
  # Analisi traccia covarianza
  covariance_analysis:
    enabled: true
    detect_convergence: true             # Rileva punto di convergenza automaticamente
    stability_threshold: 0.1             # Soglia coefficiente di variazione per stabilità
    transient_phase_percentage: 0.2     # Percentuale iniziale considerata fase transiente
  
  # Analisi residui e outlier
  residual_analysis:
    enabled: true
    outlier_detection_method: '3sigma'   # Metodo rilevamento outlier ('3sigma', 'iqr', 'zscore')
    max_outlier_percentage: 5.0          # Percentuale massima outlier accettabile
    min_r_squared: 0.7                   # R² minimo misurato vs stimato
    test_heteroscedasticity: true        # Test eteroschedasticità residui
  
  # Generazione automatica raccomandazioni tuning
  tuning_recommendations:
    enabled: true
    adaptive_threshold: true             # Soglie adattive basate su stima rumore
    suggest_zupt_params: true            # Suggerisce parametri ZUPT ottimali
    suggest_process_noise: true          # Suggerisce valori Q ottimali

# Input files configuration
input_files:
  linear: "data/inputs/FILE_SENSOR_ACCELERATION_LINEAR2023-3-21-11-6-14.txt"
  uncalibrated: "data/inputs/FILE_SENSOR_ACCELERATION_UNCALIBRATED2023-3-21-11-6-14.txt"

# Output files configuration  
output_files:
  base_dir: "data/outputs"
  position_csv: "estimated_position_{axis}.csv"
  velocity_csv: "estimated_velocity_{axis}.csv"
  plots_png: "ekf_plots_{axis}.png"
  performance_yaml: "EKF_performance_report_axis_{axis}.yaml"
  tuning_json: "tuning_report_{axis}.json"
  auto_tuning_recommendations:
    enabled: true
    priority_levels: ['high', 'medium', 'low']  # Livelli priorità raccomandazioni
    suggest_parameter_adjustments: true  # Suggerisci fattori aggiustamento parametri
    
  # Confronto multi-asse (quando analysis_axis = 'all')
  multi_axis_comparison:
    enabled: true
    generate_comparison_plots: true      # Grafici comparativi tra assi
    calculate_performance_scores: true   # Calcola score performance per asse
    identify_best_worst_axis: true       # Identifica asse migliore/peggiore
    global_recommendations: true         # Raccomandazioni globali sistema
